suite: temporal-disabled-tests
templates:
  - ../templates/llamacloud/deployment.yaml
  - ../templates/llamacloud/service.yaml
  - ../templates/llamacloud/job.yaml
release:
  name: llamacloud
  namespace: default
capabilities:
  majorVersion: 1
  minorVersion: 28
tests:
  # Main test: verify NO temporal resources are created when temporal.enabled is false
  - it: should not create temporal job when temporal.enabled is false
    set:
      temporal.enabled: false
    template: ../templates/llamacloud/job.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Test with temporal.enabled explicitly set to false with other configurations
  - it: should not create temporal job even when other temporal configurations exist
    set:
      temporal.enabled: false
      temporal.host: "external-temporal.example.com"
      temporal.port: 7233
    template: ../templates/llamacloud/job.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Positive test: verify job IS created when temporal.enabled is true
  - it: should create temporal search attributes job when temporal.enabled is true
    set:
      temporal.enabled: true
      temporal.host: "temporal.example.com"
      temporal.port: 7233
      config.temporal.searchAttributesJob.enabled: true
      config.temporal.searchAttributesJob.image: "temporalio/admin-tools:latest"
      config.temporal.searchAttributesJob.attributes:
        - name: "CustomStringAttr"
          type: "Keyword"
    template: ../templates/llamacloud/job.yaml
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: llamacloud-temporal-search-attributes

  # Verify that standard deployments are still created regardless of temporal.enabled
  - it: should still create standard deployments when temporal is disabled
    set:
      temporal.enabled: false
      config.frontend.enabled: false
      config.parseOcr.enabled: false
      config.parseLayoutDetection.enabled: false
    template: ../templates/llamacloud/deployment.yaml
    asserts:
      - hasDocuments:
          count: 5

  - it: should still create standard services when temporal is disabled
    set:
      temporal.enabled: false
      config.frontend.enabled: false
      config.parseOcr.enabled: false
      config.parseLayoutDetection.enabled: false
    template: ../templates/llamacloud/service.yaml
    asserts:
      - hasDocuments:
          count: 5
