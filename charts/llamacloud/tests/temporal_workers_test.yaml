suite: temporal-workers-tests
templates:
  - ../templates/temporal_workers/python_worker/deployment.yaml
  - ../templates/temporal_workers/python_worker/configmap.yaml
  - ../templates/temporal_workers/python_worker/service.yaml
  - ../templates/temporal_workers/python_worker/hpa.yaml
  - ../templates/temporal_workers/python_worker/keda-scaledobject.yaml
  - ../templates/temporal_workers/python_worker/secret.yaml
  - ../templates/temporal_workers/python_worker/serviceaccount.yaml
  - ../templates/temporal_workers/python_worker/servicemonitor.yaml
release:
  name: llamacloud
  namespace: default
capabilities:
  majorVersion: 1
  minorVersion: 28
tests:
  # Test that nothing is created when temporal is disabled
  - it: should not create temporal workers resources when temporal is disabled
    set:
      temporal.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # Python Worker Deployment Tests
  - it: should create python worker deployment with correct configuration
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: llamacloud-temporal-python-worker
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: temporal_worker
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8000

  # Python Worker ConfigMap Tests
  - it: should create python worker configmap with temporal environment variables
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/configmap.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: data.TEMPORAL_HOST
          value: "llamacloud-temporal-frontend.default.svc.cluster.local"
      - equal:
          path: data.TEMPORAL_PORT
          value: "7233"
      - equal:
          path: data.IS_DEPLOYED
          value: "true"
      - equal:
          path: data.IS_TEMPORAL_WORKER
          value: "true"
      - equal:
          path: data.TEMPORAL_WORKER_REGISTRY_PROFILE
          value: "consolidated"

  - it: should allow customizing temporal worker registry profile
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.config.temporalWorkerRegistryProfile: "default"
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/configmap.yaml
    asserts:
      - equal:
          path: data.TEMPORAL_WORKER_REGISTRY_PROFILE
          value: "default"

  - it: should include S3 bucket configurations in python worker configmap
    set:
      temporal.enabled: true
      global.config.parsedDocumentsCloudBucketName: test-documents
      global.config.parsedRawFileCloudBucketName: test-raw-files
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/configmap.yaml
    asserts:
      - equal:
          path: data.S3_DOCUMENT_BUCKET_NAME
          value: test-documents
      - equal:
          path: data.S3_RAW_FILE_BUCKET_NAME
          value: test-raw-files

  # Python Worker Service Tests
  - it: should create python worker service with correct port
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].port
          value: 8000
      - equal:
          path: spec.ports[0].targetPort
          value: worker-http

  # Python Worker HPA Tests
  - it: should create HPA when autoscaling is enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.autoscaling.enabled: true
      temporalWorkers.pythonWorker.autoscaling.minReplicas: 2
      temporalWorkers.pythonWorker.autoscaling.maxReplicas: 10
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/hpa.yaml
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should not create HPA when autoscaling is disabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.autoscaling.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/hpa.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Python Worker KEDA Tests
  - it: should create KEDA scaled object when enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.keda.enabled: true
      temporalWorkers.pythonWorker.keda.minReplicaCount: 1
      temporalWorkers.pythonWorker.keda.maxReplicaCount: 50
      temporalWorkers.pythonWorker.keda.triggers:
        - type: temporal
          metadata:
            taskQueue: "parse"
            targetQueueSize: "2"
            activationTargetQueueSize: "0"
            endpoint: "temporal:7233"
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    capabilities:
      apiVersions:
        - keda.sh/v1alpha1
    template: ../templates/temporal_workers/python_worker/keda-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 1
      - equal:
          path: spec.maxReplicaCount
          value: 50

  - it: should not create KEDA when disabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.keda.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/keda-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Python Worker Secret Tests
  - it: should create python worker secret when external secrets disabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.externalSecrets.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: llamacloud-temporal-python-worker-secret

  - it: should not create python worker secret when external secrets enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.externalSecrets.enabled: true
      temporalWorkers.pythonWorker.externalSecrets.secrets:
        - external-secret-1
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Python Worker ServiceAccount Tests
  - it: should create python worker service account when create is true
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.serviceAccount.create: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/serviceaccount.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: llamacloud-temporal-python-worker

  - it: should not create python worker service account when create is false
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.serviceAccount.create: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/serviceaccount.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom service account name when provided
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.serviceAccount.create: true
      temporalWorkers.pythonWorker.serviceAccount.name: custom-sa-name
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa-name

  # Python Worker ServiceMonitor Tests
  - it: should create python worker ServiceMonitor when monitoring is enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.metrics.enabled: true
      temporalWorkers.pythonWorker.metrics.serviceMonitor.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    template: ../templates/temporal_workers/python_worker/servicemonitor.yaml
    asserts:
      - isKind:
          of: ServiceMonitor

  - it: should not create python worker ServiceMonitor when monitoring is disabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.metrics.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/servicemonitor.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Replicas Configuration Tests
  - it: should set replicas field when both autoscaling and KEDA are disabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.replicas: 3
      temporalWorkers.pythonWorker.autoscaling.enabled: false
      temporalWorkers.pythonWorker.keda.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/deployment.yaml
    asserts:
      - equal:
          path: .spec.replicas
          value: 3

  - it: should not set replicas field when autoscaling is enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.replicas: 3
      temporalWorkers.pythonWorker.autoscaling.enabled: true
      temporalWorkers.pythonWorker.keda.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/deployment.yaml
    asserts:
      - notExists:
          path: .spec.replicas

  - it: should not set replicas field when KEDA is enabled
    set:
      temporal.enabled: true
      temporalWorkers.pythonWorker.replicas: 3
      temporalWorkers.pythonWorker.autoscaling.enabled: false
      temporalWorkers.pythonWorker.keda.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_workers/python_worker/deployment.yaml
    asserts:
      - notExists:
          path: .spec.replicas
