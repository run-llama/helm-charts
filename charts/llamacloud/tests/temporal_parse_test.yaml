suite: temporal-parse-tests
templates:
  - ../templates/temporal_parse/llamaparse/deployment.yaml
  - ../templates/temporal_parse/llamaparse/configmap.yaml
  - ../templates/temporal_parse/llamaparse/service.yaml
  - ../templates/temporal_parse/llamaparse/hpa.yaml
  - ../templates/temporal_parse/llamaparse/keda-scaledobject.yaml
  - ../templates/temporal_parse/llamaparse/pdb.yaml
  - ../templates/temporal_parse/llamaparse/prometheusrule.yaml
  - ../templates/temporal_parse/llamaparse/secret.yaml
  - ../templates/temporal_parse/llamaparse/serviceaccount.yaml
  - ../templates/temporal_parse/llamaparse/servicemonitor.yaml
release:
  name: llamacloud
  namespace: default
capabilities:
  majorVersion: 1
  minorVersion: 28
tests:
  # Test that nothing is created when temporal is disabled
  - it: should not create temporal parse resources when temporal is disabled
    set:
      temporal.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # llamaparse Worker Tests
  - it: should create llamaparse deployment with correct configuration
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: llamacloud-temporal-llamaparse
      - equal:
          path: spec.template.spec.containers[0].command[2]
          value: exec node --max-old-space-size=$MAX_OLD_SPACE_SIZE dist/worker/temporal/worker.js
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8004

  - it: should create llamaparse configmap with correct configuration
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/configmap.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: data.DEBUG_MODE
          value: "false"
      - equal:
          path: data.CLOUD_PROVIDER
          value: "aws"

  - it: should create llamaparse secret when external secrets disabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.externalSecrets.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: llamacloud-temporal-llamaparse-secret

  - it: should not create llamaparse secret when external secrets enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.externalSecrets.enabled: true
      temporalParse.llamaParse.externalSecrets.secrets:
        - external-secret-1
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create llamaparse service
    set:
      temporal.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].port
          value: 8004

  - it: should create llamaparse HPA when autoscaling is enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.autoscaling.enabled: true
      temporalParse.llamaParse.autoscaling.minReplicas: 2
      temporalParse.llamaParse.autoscaling.maxReplicas: 10
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/hpa.yaml
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should not create llamaparse HPA when autoscaling is disabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.autoscaling.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/hpa.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create llamaparse KEDA scaled object when enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.enabled: true
      temporalParse.llamaParse.autoscaling.enabled: false
      temporalParse.llamaParse.keda.enabled: true
      temporalParse.llamaParse.keda.minReplicaCount: 1
      temporalParse.llamaParse.keda.maxReplicaCount: 50
      temporalParse.llamaParse.keda.triggers:
        - type: prometheus
          metadata:
            serverAddress: http://prometheus:9090
            query: sum(rate(temporal_worker_task_slots_available[5m]))
            threshold: "10"
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    capabilities:
      apiVersions:
        - keda.sh/v1alpha1
    template: ../templates/temporal_parse/llamaparse/keda-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 1
      - equal:
          path: spec.maxReplicaCount
          value: 50

  - it: should not create llamaparse KEDA when disabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.keda.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/keda-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create llamaparse PDB when enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.podDisruptionBudget.enabled: true
      temporalParse.llamaParse.podDisruptionBudget.maxUnavailable: 1
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/pdb.yaml
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.maxUnavailable
          value: 1

  - it: should not create llamaparse PDB when disabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.podDisruptionBudget.enabled: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/pdb.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create llamaparse PrometheusRule when enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.metrics.enabled: true
      temporalParse.llamaParse.metrics.rules.enabled: true
      temporalParse.llamaParse.metrics.rules.spec:
        - alert: TestAlert
          expr: up == 0
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    template: ../templates/temporal_parse/llamaparse/prometheusrule.yaml
    asserts:
      - isKind:
          of: PrometheusRule

  - it: should create llamaparse ServiceMonitor when monitoring is enabled
    set:
      temporal.enabled: true
      temporalParse.llamaParse.metrics.enabled: true
      temporalParse.llamaParse.metrics.serviceMonitor.enabled: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    template: ../templates/temporal_parse/llamaparse/servicemonitor.yaml
    asserts:
      - isKind:
          of: ServiceMonitor

  - it: should create llamaparse service account when create is true
    set:
      temporal.enabled: true
      temporalParse.llamaParse.serviceAccount.create: true
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/serviceaccount.yaml
    asserts:
      - isKind:
          of: ServiceAccount

  - it: should not create llamaparse service account when create is false
    set:
      temporal.enabled: true
      temporalParse.llamaParse.serviceAccount.create: false
      mongodb.enabled: false
      postgresql.enabled: false
      rabbitmq.enabled: false
      redis.enabled: false
    template: ../templates/temporal_parse/llamaparse/serviceaccount.yaml
    asserts:
      - hasDocuments:
          count: 0

